<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket AI Trading | b1rdmania</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>polymarket ai trading</h1>
                    <p class="subtitle">MEAN REVERSION ON PREDICTION MARKETS</p>
                    <p style="margin-top: 8px; font-size: 0.85rem;">by <a href="https://github.com/b1rdmania" target="_blank">b1rdmania</a></p>
                </div>
                <div style="text-align: right;">
                    <div id="api-status" style="font-family: var(--font-mono); font-size: 0.75rem; margin-bottom: 4px;">● connecting...</div>
                    <a href="https://github.com/b1rdmania/polymarket-ai-trading" target="_blank" class="btn">View Code</a>
                </div>
            </div>
        </header>

        <nav>
            <a href="index.html" class="active">Dashboard</a>
            <a href="results.html">Results</a>
            <a href="markets.html">Scanner</a>
            <a href="research.html">Research</a>
        </nav>

        <div class="content">
            <!-- Performance Summary -->
            <div class="card">
                <h3>Performance</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; margin-top: 16px;">
                    <div class="stat-box">
                        <div style="font-size: 0.75rem; color: var(--color-gray-mid); margin-bottom: 4px;">MODE</div>
                        <strong>Paper Trading</strong>
                    </div>
                    <div class="stat-box">
                        <div style="font-size: 0.75rem; color: var(--color-gray-mid); margin-bottom: 4px;">TOTAL TRADES</div>
                        <strong id="total-trades">--</strong>
                    </div>
                    <div class="stat-box">
                        <div style="font-size: 0.75rem; color: var(--color-gray-mid); margin-bottom: 4px;">OPEN</div>
                        <strong id="open-positions">--</strong>
                    </div>
                    <div class="stat-box">
                        <div style="font-size: 0.75rem; color: var(--color-gray-mid); margin-bottom: 4px;">CLOSED</div>
                        <strong id="closed-trades">--</strong>
                    </div>
                    <div class="stat-box">
                        <div style="font-size: 0.75rem; color: var(--color-gray-mid); margin-bottom: 4px;">WIN RATE</div>
                        <strong id="win-rate">--</strong>
                    </div>
                    <div class="stat-box">
                        <div style="font-size: 0.75rem; color: var(--color-gray-mid); margin-bottom: 4px;">REALIZED P&L</div>
                        <strong id="realized-pnl" style="color: var(--color-success);">--</strong>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <h3>Recent Activity</h3>
                <div id="recent-activity" style="margin-top: 16px; font-family: var(--font-mono); font-size: 0.8rem;">
                    <p style="color: var(--color-gray-mid);">Loading...</p>
                </div>
            </div>

            <!-- Open Positions -->
            <div class="card">
                <h3>Open Positions</h3>
                <div id="positions-container" style="margin-top: 16px;">
                    <p style="color: var(--color-gray-mid);">Loading...</p>
                </div>
            </div>

            <!-- Footer -->
            <div style="margin-top: 40px; padding-top: 24px; border-top: 1px solid var(--color-border); color: var(--color-gray-mid); font-size: 0.85rem;">
                <p><strong>Paper trading only.</strong> Models scan Polymarket for mean reversion opportunities. See <a href="results.html">Results</a> for full trade history.</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://polymarket-trading-system.onrender.com';
        
        async function loadDashboard() {
            try {
                // Fetch health
                const healthResp = await fetch(`${API_BASE}/api/health`);
                const health = await healthResp.json();
                
                document.getElementById('api-status').textContent = '● connected';
                document.getElementById('api-status').style.color = 'var(--color-success)';
                
                // Fetch all trades
                const tradesResp = await fetch(`${API_BASE}/api/signals/live?limit=200`);
                const tradesData = await tradesResp.json();
                const trades = tradesData.signals || [];
                
                const closed = trades.filter(t => t.status === 'closed');
                const open = trades.filter(t => t.status === 'open');
                
                // Update stats
                document.getElementById('total-trades').textContent = trades.length;
                document.getElementById('open-positions').textContent = open.length;
                document.getElementById('closed-trades').textContent = closed.length;
                
                const realizedPnl = closed.reduce((sum, t) => sum + (t.pnl || 0), 0);
                const wins = closed.filter(t => (t.pnl || 0) > 0).length;
                const winRate = closed.length > 0 ? (wins / closed.length * 100).toFixed(0) : '--';
                
                document.getElementById('realized-pnl').textContent = `$${realizedPnl.toFixed(2)}`;
                document.getElementById('realized-pnl').style.color = realizedPnl >= 0 ? 'var(--color-success)' : 'var(--color-error)';
                document.getElementById('win-rate').textContent = winRate !== '--' ? winRate + '%' : '--';
                
                // Recent activity
                renderRecentActivity(trades.slice(0, 10));
                
                // Open positions
                await renderOpenPositions();
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('api-status').textContent = '● error';
                document.getElementById('api-status').style.color = 'var(--color-error)';
            }
        }
        
        function renderRecentActivity(trades) {
            const container = document.getElementById('recent-activity');
            
            if (trades.length === 0) {
                container.innerHTML = '<p style="color: var(--color-gray-mid);">No trades yet.</p>';
                return;
            }
            
            let html = '<div style="max-height: 300px; overflow-y: auto;">';
            for (const t of trades) {
                const time = new Date(t.timestamp).toLocaleString();
                const pnl = t.pnl || 0;
                const status = t.status === 'closed' ? 
                    `<span style="color: ${pnl >= 0 ? 'var(--color-success)' : 'var(--color-error)'}">CLOSED $${pnl.toFixed(2)}</span>` : 
                    '<span style="color: var(--color-gray-mid)">OPEN</span>';
                
                html += `<div style="padding: 8px 0; border-bottom: 1px solid var(--color-border);">`;
                html += `<div>${t.direction} @ ${(t.entry_price * 100).toFixed(1)}% - ${t.market.substring(0, 45)}</div>`;
                html += `<div style="color: var(--color-gray-mid); font-size: 0.75rem;">${time} | ${status}</div>`;
                html += `</div>`;
            }
            html += '</div>';
            container.innerHTML = html;
        }
        
        async function renderOpenPositions() {
            const container = document.getElementById('positions-container');
            
            try {
                const resp = await fetch(`${API_BASE}/api/debug/positions`);
                const data = await resp.json();
                
                let positions = [];
                for (const [model, info] of Object.entries(data)) {
                    if (info && info.sample) {
                        for (const pos of info.sample) {
                            positions.push(pos);
                        }
                    }
                }
                
                if (positions.length === 0) {
                    container.innerHTML = '<p style="color: var(--color-gray-mid);">No open positions.</p>';
                    return;
                }
                
                let html = '<table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">';
                html += '<thead><tr style="text-align: left; border-bottom: 1px solid var(--color-gray-dark);">';
                html += '<th style="padding: 8px;">Market</th>';
                html += '<th style="padding: 8px;">Side</th>';
                html += '<th style="padding: 8px;">Entry</th>';
                html += '<th style="padding: 8px;">Current</th>';
                html += '<th style="padding: 8px;">P&L</th>';
                html += '</tr></thead><tbody>';
                
                for (const pos of positions.slice(0, 15)) {
                    const pnl = pos.pnl_pct || 0;
                    const pnlColor = pnl >= 0 ? 'var(--color-success)' : 'var(--color-error)';
                    
                    html += '<tr style="border-bottom: 1px solid var(--color-border);">';
                    html += `<td style="padding: 8px;">${(pos.question || '').substring(0, 40)}</td>`;
                    html += `<td style="padding: 8px;">${pos.side}</td>`;
                    html += `<td style="padding: 8px;">${(pos.entry * 100).toFixed(1)}%</td>`;
                    html += `<td style="padding: 8px;">${pos.current ? (pos.current * 100).toFixed(1) + '%' : '--'}</td>`;
                    html += `<td style="padding: 8px; color: ${pnlColor};">${pnl >= 0 ? '+' : ''}${pnl.toFixed(1)}%</td>`;
                    html += '</tr>';
                }
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (e) {
                container.innerHTML = '<p style="color: var(--color-gray-mid);">Error loading positions.</p>';
            }
        }
        
        // Load on page load and refresh every 60s
        loadDashboard();
        setInterval(loadDashboard, 60000);
    </script>
</body>
</html>
