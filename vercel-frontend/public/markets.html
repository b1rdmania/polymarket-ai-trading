<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Markets | Polymarket AI Trading</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>polymarket ai trading</h1>
                    <p class="subtitle">LIVE MARKET DATA</p>
                </div>
                <a href="https://github.com/b1rdmania/polymarket-ai-trading" target="_blank" class="btn">View Code</a>
            </div>
        </header>

        <nav>
            <a href="index.html">Dashboard</a>
            <a href="markets.html" class="active">Live Markets</a>
            <a href="research.html">Research</a>
        </nav>

        <div class="content">
            <div class="card">
                <h3>Top Markets by Volume</h3>
                <p style="color: var(--color-gray-mid); font-size: 0.9rem; margin-top: 8px;">Live data from Polymarket. Updated every 30 seconds.</p>
                
                <div id="markets-list" style="margin-top: 24px;">
                    <div class="loader">Loading markets...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Use our backend proxy (Gamma API doesn't allow CORS)
        const API_BASE = 'https://polymarket-trading-system.onrender.com';
        
        async function loadMarkets() {
            try {
                const container = document.getElementById('markets-list');
                container.innerHTML = '<div class="loader">Fetching markets from Polymarket...</div>';
                
                // Fetch via our backend proxy
                const response = await fetch(`${API_BASE}/api/markets/live`);
                
                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }
                
                const data = await response.json();
                const topMarkets = data.markets || [];
                
                console.log(`Loaded ${topMarkets.length} markets via proxy`);
                
                container.innerHTML = '';
                
                if (topMarkets.length === 0) {
                    container.innerHTML = '<p style="color: var(--color-gray-mid);">No active markets found with sufficient volume.</p>';
                    return;
                }
                
                topMarkets.forEach((market, index) => {
                    const card = document.createElement('div');
                    card.style.padding = '16px';
                    card.style.border = '1px solid var(--color-border)';
                    card.style.marginBottom = '12px';
                    card.style.borderRadius = '4px';
                    
                    // Parse outcomePrices - array like ["0.65", "0.35"]
                    let yesPrice = '--';
                    let noPrice = '--';
                    const prices = market.outcomePrices;
                    if (prices && Array.isArray(prices) && prices.length >= 2) {
                        const yes = parseFloat(prices[0]);
                        const no = parseFloat(prices[1]);
                        if (!isNaN(yes)) yesPrice = (yes * 100).toFixed(0);
                        if (!isNaN(no)) noPrice = (no * 100).toFixed(0);
                    }
                    
                    // Format volume
                    const vol = parseFloat(market.volume || 0);
                    let volumeStr = '$0';
                    if (vol >= 1000000) {
                        volumeStr = `$${(vol / 1000000).toFixed(1)}M`;
                    } else if (vol >= 1000) {
                        volumeStr = `$${(vol / 1000).toFixed(0)}k`;
                    } else {
                        volumeStr = `$${vol.toFixed(0)}`;
                    }
                    
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px;">
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--color-gray-mid); margin-bottom: 4px;">
                                    #${index + 1} · ${volumeStr} volume
                                </div>
                                <div style="margin-bottom: 0; font-size: 0.95rem; font-weight: 500; text-transform: none !important;">${market.question || 'Unknown'}</div>
                            </div>
                            <div style="text-align: right; min-width: 100px;">
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <div>
                                        <div style="font-size: 0.7rem; color: var(--color-gray-mid);">YES</div>
                                        <div style="font-family: var(--font-mono); font-size: 1rem; font-weight: 600; color: #16a34a;">${yesPrice}¢</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.7rem; color: var(--color-gray-mid);">NO</div>
                                        <div style="font-family: var(--font-mono); font-size: 1rem; font-weight: 600; color: #dc2626;">${noPrice}¢</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
                
            } catch (error) {
                console.error('Error loading markets:', error);
                document.getElementById('markets-list').innerHTML = `
                    <p style="color: var(--color-error);">Failed to load markets: ${error.message}</p>
                    <p style="color: var(--color-gray-mid); margin-top: 8px; font-size: 0.9rem;">
                        Try refreshing the page. If the error persists, the Polymarket API may be down.
                    </p>
                `;
            }
        }

        loadMarkets();
        setInterval(loadMarkets, 30000); // Refresh every 30s
    </script>
</body>
</html>
